<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building a Production-Ready K3s Homelab | Ahmed</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700;800&family=Fira+Code:wght@300;400;500;600;700&family=Source+Code+Pro:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        .blog-post {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        .blog-post h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            color: var(--primary-color);
            text-shadow: var(--glow-primary);
            text-align: center;
        }
        .blog-post h2 {
            font-size: 2rem;
            margin: 3rem 0 1.5rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .blog-post h3 {
            font-size: 1.5rem;
            margin: 2rem 0 1rem;
            color: var(--text-primary);
        }
        .blog-post h4 {
            font-size: 1.25rem;
            margin: 1.5rem 0 1rem;
            color: var(--text-secondary);
        }
        .blog-post p {
            margin-bottom: 1.5rem;
            line-height: 1.8;
            color: var(--text-secondary);
        }
        .blog-post strong {
            color: var(--primary-color);
        }
        .blog-post ul, .blog-post ol {
            margin: 1.5rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        .blog-post li {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .blog-post table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            overflow-x: auto;
            display: block;
        }
        .blog-post th, .blog-post td {
            border: 1px solid var(--border-color);
            padding: 1rem;
            text-align: left;
        }
        .blog-post th {
            background: var(--bg-card);
            color: var(--primary-color);
            font-weight: 600;
        }
        .blog-post td {
            color: var(--text-secondary);
        }
        .blog-post img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 2rem auto;
            display: block;
            border: 1px solid var(--border-color);
        }
        .blog-post pre {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--primary-color);
            display: block;
            margin: 1.5rem 0;
        }
        .blog-post code {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.2rem 0.4rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--primary-color);
        }
        .blog-post pre code {
            background: none;
            border: none;
            padding: 0;
        }
        .back-button {
            display: inline-block;
            margin-bottom: 2rem;
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .back-button:hover {
            border-color: var(--primary-color);
            transform: translateX(-5px);
        }
        .info-box {
            background: var(--bg-card);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }
        .ascii-diagram {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            color: var(--text-secondary);
        }
        hr {
            border: none;
            border-top: 2px solid var(--border-color);
            margin: 3rem 0;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="images/netops.jpg" alt="NetOps Journal Logo" class="nav-logo-img">
                <div class="nav-logo-text">
                    <a href="index.html">NetOps Journal</a>
                    <span class="nav-logo-tagline">Where networking meets automation.</span>
                </div>
            </div>
            <button class="menu-toggle" id="menuToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu" id="navMenu">
                <li class="nav-item dropdown">
                    <a href="#" class="nav-link">Categories</a>
                    <ul class="dropdown-menu">
                        <li><a href="index.html#all">All</a></li>
                        <li><a href="index.html#kubernetes">Kubernetes</a></li>
                        <li><a href="index.html#automation">Automation</a></li>
                        <li><a href="index.html#opensource">Open-source</a></li>
                        <li><a href="index.html#cisco">Cisco Technologies</a></li>
                        <li><a href="index.html#juniper">Juniper Technologies</a></li>
                        <li><a href="index.html#homeautomation">Home-Automation</a></li>
                        <li><a href="index.html#homelab">Home-Lab</a></li>
                        <li><a href="index.html#certifications">Certifications</a></li>
                        <li><a href="projects.html">Projects</a></li>
                        <li><a href="index.html#labs">Labs</a></li>
                    </ul>
                </li>
                <li class="nav-item"><a href="index.html" class="nav-link">Blog</a></li>
                <li class="nav-item"><a href="projects.html" class="nav-link">Projects</a></li>
                <li class="nav-item"><a href="about.html" class="nav-link">About</a></li>
                <li class="nav-item"><a href="about.html#contact" class="nav-link">Contact</a></li>
            </ul>
        </div>
    </nav>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
        <span class="theme-toggle-icon">üé®</span>
        <span class="theme-toggle-text">Change Theme</span>
    </button>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <article class="blog-post">
                <a href="index.html" class="back-button">‚Üê Back to Blog</a>
                
                <h1>üöÄ Building a Production-Ready K3s Homelab with Proxmox and Terraform</h1>

                <div style="text-align: center; margin: 2rem 0;">
                    <img src="images/kube display image.png" alt="Kubernetes Homelab" style="max-width: 100%; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);">
                </div>

                <p>Running Kubernetes at home doesn't have to be complex or expensive. In this guide, I'll walk you through my 3-node K3s cluster built on Proxmox VE, automated with Terraform, and running on Ubuntu Server 22.04.</p>

                <p>Whether you're learning Kubernetes, testing applications, or building a home lab for development, this setup provides a solid foundation that mimics production environments without breaking the bank.</p>

                <div class="info-box" style="background: var(--bg-card); border: 2px solid var(--primary-color); border-radius: 12px; padding: 2rem; margin: 2rem 0; text-align: center;">
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">üìÇ GitHub Repository</h3>
                    <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">Get the complete Terraform configuration, deployment scripts, and documentation</p>
                    <a href="https://github.com/ahmed86-star/k3s-homelab" target="_blank" style="display: inline-flex; align-items: center; gap: 0.75rem; padding: 1rem 2rem; background: var(--primary-color); color: var(--bg-primary); text-decoration: none; border-radius: 8px; font-weight: 700; transition: all 0.3s ease; box-shadow: var(--glow-primary);">
                        <span>‚≠ê View Repository on GitHub</span>
                    </a>
                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                        <code>git clone https://github.com/ahmed86-star/k3s-homelab.git</code>
                    </p>
                </div>

                <h2>üéØ What We're Building</h2>

                <p>A lightweight, highly available Kubernetes cluster featuring:</p>

                <ul>
                    <li><strong>3 Proxmox nodes</strong> running virtualized infrastructure</li>
                    <li><strong>Automated VM deployment</strong> using Terraform</li>
                    <li><strong>K3s Kubernetes distribution</strong> for minimal resource usage</li>
                    <li><strong>1 master + 2 worker nodes</strong> for true cluster behavior</li>
                    <li><strong>All managed from a single laptop</strong> running Pop!_OS</li>
                </ul>

                <h2>üìä Architecture Diagram</h2>

                <p>Here's a visual representation of the complete setup:</p>

                <div class="info-box" style="text-align: center;">
                    <img src="images/diagram.png" alt="Kubernetes Homelab Architecture" style="max-width: 100%; border-radius: 8px;">
                    <p style="margin-top: 1rem; color: var(--text-secondary); font-style: italic;">
                        <strong>K3s Cluster Architecture</strong> - Terraform deploys to Proxmox, creating a 3-node Kubernetes cluster with 1 master and 2 worker nodes
                    </p>
                </div>

                <div class="info-box" style="text-align: center;">
                    <img src="images/proxmox instace .png" alt="Proxmox Virtual Environment Instances" style="max-width: 100%; border-radius: 8px;">
                    <p style="margin-top: 1rem; color: var(--text-secondary); font-style: italic;">
                        <strong>Proxmox VE Dashboard</strong> - Running K3s cluster nodes as virtual machines in Proxmox Virtual Environment
                    </p>
                </div>

                <h2>üèóÔ∏è Architecture Overview</h2>

                <h3>Physical Hardware</h3>

                <p>My setup consists of relatively modest hardware that you might already have lying around:</p>

                <ul>
                    <li><strong>3 √ó Proxmox VE nodes</strong> (repurposed desktop hardware or mini PCs work great)</li>
                    <li><strong>1 √ó Lenovo laptop</strong> running Pop!_OS (my admin machine for SSH, Terraform, and kubectl)</li>
                    <li><strong>1 √ó Netgear GS108E switch</strong> (any managed or unmanaged gigabit switch works)</li>
                </ul>

                <p>The beauty of this setup is its scalability. Start with what you have and expand as needed.</p>

                <h3>Admin Workstation</h3>

                <div class="info-box" style="text-align: center;">
                    <img src="images/lenovo pop os.png" alt="Lenovo Laptop with Pop!_OS" style="max-width: 100%; border-radius: 8px;">
                    <p style="margin-top: 1rem; color: var(--text-secondary); font-style: italic;">
                        <strong>Lenovo Admin Workstation</strong> - Running Pop!_OS as the main configuration and management machine with SSH, Terraform, VSCode, and kubectl
                    </p>
                </div>

                <h3>Physical Setup</h3>

                <div class="info-box" style="text-align: center;">
                    <img src="images/rack.png" alt="DeskPi RackMate T1-Plus Rackmount Setup" style="max-width: 100%; border-radius: 8px;">
                    <p style="margin-top: 1rem; color: var(--text-secondary); font-style: italic;">
                        <strong>DeskPi RackMate T1-Plus Rackmount</strong> - 10-inch 8U Server Cabinet for Network, Servers, Audio and Video Equipment
                    </p>
                </div>

                <div class="info-box" style="text-align: center;">
                    <img src="images/image (3).jpeg" alt="CAT6A Patch Cables" style="max-width: 100%; border-radius: 8px;">
                    <p style="margin-top: 1rem; color: var(--text-secondary); font-style: italic;">
                        <strong>CAT6A Patch Cables</strong> - High-performance Ethernet cables providing reliable gigabit connectivity between network devices
                    </p>
                </div>

                <h3>Network Architecture</h3>

                <p>I'm using a simple flat network design with static IP assignments. For this blog post, I've masked the actual IPs to a documentation-friendly range:</p>

                <p><strong>Internal subnet:</strong> <code>10.10.10.0/24</code></p>

                <table>
                    <thead>
                        <tr>
                            <th>Hostname</th>
                            <th>Role</th>
                            <th>IP Address</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>cluster</td>
                            <td>K3s master</td>
                            <td>10.10.10.11</td>
                            <td>Control plane node</td>
                        </tr>
                        <tr>
                            <td>worker1</td>
                            <td>K3s agent</td>
                            <td>10.10.10.12</td>
                            <td>Worker node</td>
                        </tr>
                        <tr>
                            <td>worker3</td>
                            <td>K3s agent</td>
                            <td>10.10.10.13</td>
                            <td>Worker node</td>
                        </tr>
                        <tr>
                            <td>lenovo</td>
                            <td>Admin machine</td>
                            <td>10.10.10.20</td>
                            <td>Management workstation</td>
                        </tr>
                        <tr>
                            <td>netgear</td>
                            <td>Switch</td>
                            <td>10.10.10.1</td>
                            <td>Network gateway</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Switch Port Mapping</h3>

                <p>Here's how everything connects to my Netgear GS108E:</p>

                <table>
                    <thead>
                        <tr>
                            <th>Port</th>
                            <th>Device</th>
                            <th>Hostname</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Proxmox Node 1</td>
                            <td>cluster</td>
                            <td>K3s master node</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Proxmox Node 2</td>
                            <td>worker1</td>
                            <td>K3s worker</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Proxmox Node 3</td>
                            <td>worker3</td>
                            <td>K3s worker</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>Lenovo Pop!_OS</td>
                            <td>lenovo</td>
                            <td>Admin workstation</td>
                        </tr>
                        <tr>
                            <td>5-8</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>Available for expansion</td>
                        </tr>
                    </tbody>
                </table>

                <h2>üìã Prerequisites</h2>

                <p>Before diving in, ensure you have:</p>

                <ol>
                    <li><strong>Three machines with Proxmox VE installed</strong> (version 7.x or 8.x)</li>
                    <li><strong>A management machine</strong> with SSH, Terraform, and kubectl installed</li>
                    <li><strong>Basic networking</strong> configured on all Proxmox nodes</li>
                    <li><strong>An Ubuntu 22.04 cloud image</strong> or VM template in Proxmox</li>
                    <li><strong>SSH key pair</strong> for passwordless authentication</li>
                </ol>

                <h2>üîß Part 1: Proxmox VM Configuration</h2>

                <p>Each Kubernetes node runs as a VM on Proxmox with these specifications:</p>

                <h3>Ubuntu VM Template Specs</h3>

                <pre><code>CPU: 2 cores (can scale up based on workload)
RAM: 4-8 GB (4GB minimum for K3s)
Disk: 20-40 GB (thin provisioned)
Boot: UEFI (required for modern Ubuntu)
Network: Bridged (vmbr0)</code></pre>

                <p><strong>Why these specs?</strong> K3s is incredibly lightweight compared to full Kubernetes. The master node comfortably runs on 2 cores and 4GB RAM, while workers can start even smaller and scale as needed.</p>

                <h3>Creating the Ubuntu Template</h3>

                <p>If you haven't already, create a VM template in Proxmox:</p>

                <ol>
                    <li>Download Ubuntu 22.04 cloud image</li>
                    <li>Create a VM in Proxmox</li>
                    <li>Configure cloud-init settings</li>
                    <li>Convert to template</li>
                </ol>

                <p>This template becomes the foundation for Terraform automation.</p>

                <h2>üõ†Ô∏è Part 2: Terraform Automation</h2>

                <p>Infrastructure as Code makes this setup reproducible and version-controlled. Here's my Terraform structure:</p>

                <pre><code>terraform/
‚îú‚îÄ‚îÄ main.tf                 # Provider and main configuration
‚îú‚îÄ‚îÄ variables.tf            # Variable definitions
‚îú‚îÄ‚îÄ proxmox-master.tf       # Master node definition
‚îú‚îÄ‚îÄ proxmox-worker1.tf      # Worker 1 definition
‚îú‚îÄ‚îÄ proxmox-worker3.tf      # Worker 3 definition
‚îî‚îÄ‚îÄ cloud-init/             # Cloud-init configurations
    ‚îú‚îÄ‚îÄ master.yaml
    ‚îú‚îÄ‚îÄ worker1.yaml
    ‚îî‚îÄ‚îÄ worker3.yaml</code></pre>

                <div class="info-box" style="text-align: center;">
                    <img src="images/vscode.png" alt="VSCode on Pop!_OS for Infrastructure Management" style="max-width: 100%; border-radius: 8px;">
                    <p style="margin-top: 1rem; color: var(--text-secondary); font-style: italic;">
                        <strong>Development Environment</strong> - Managing K3s infrastructure as code using VSCode on Pop!_OS with Terraform configuration files
                    </p>
                </div>

                <div style="background: var(--bg-card); border-left: 4px solid var(--primary-color); padding: 1.5rem; margin: 2rem 0; border-radius: 8px;">
                    <p style="margin: 0; color: var(--text-secondary);">
                        üí° <strong style="color: var(--primary-color);">Get the Complete Code:</strong> All Terraform configurations, deployment scripts, and detailed documentation are available in the 
                        <a href="https://github.com/ahmed86-star/k3s-homelab" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">k3s-homelab repository</a> on GitHub. 
                        Includes quick start guides, security best practices, and troubleshooting tips.
                    </p>
                </div>

                <h3>Key Terraform Variables</h3>

                <pre><code># variables.tf
variable "master_ip" {
  default = "10.10.10.11"
}

variable "worker1_ip" {
  default = "10.10.10.12"
}

variable "worker3_ip" {
  default = "10.10.10.13"
}

variable "gateway" {
  default = "10.10.10.1"
}

variable "vm_cpu_cores" {
  default = 2
}

variable "vm_memory" {
  default = 4096
}</code></pre>

                <h3>What Terraform Does</h3>

                <p>For each node, Terraform:</p>

                <ol>
                    <li><strong>Clones the Ubuntu template</strong> from Proxmox</li>
                    <li><strong>Injects cloud-init configuration</strong> with hostname and network settings</li>
                    <li><strong>Assigns a static IP address</strong> from our planned network</li>
                    <li><strong>Boots the VM</strong> ready for K3s installation</li>
                </ol>

                <p>The beauty here is consistency. All three nodes are configured identically (except for IPs and hostnames), eliminating configuration drift.</p>

                <h3>Deploying with Terraform</h3>

                <pre><code># Initialize Terraform
terraform init

# Preview changes
terraform plan

# Deploy all VMs
terraform apply -auto-approve</code></pre>

                <p>Within minutes, you'll have three fresh Ubuntu VMs ready for Kubernetes.</p>

                <h2>üêã Part 3: Installing K3s</h2>

                <p>K3s is a lightweight Kubernetes distribution perfect for edge computing, IoT, CI/CD, and homelabs. It's a single binary under 100MB that includes everything you need.</p>

                <h3>Step 1: Install K3s on Master Node</h3>

                <p>SSH into the master node from your admin machine:</p>

                <pre><code>ssh ubuntu@10.10.10.11</code></pre>

                <p>Install K3s server (master):</p>

                <pre><code>curl -sfL https://get.k3s.io | sh -</code></pre>

                <p>This single command:</p>

                <ul>
                    <li>Downloads and installs K3s</li>
                    <li>Sets up systemd services</li>
                    <li>Configures the control plane</li>
                    <li>Starts the Kubernetes API server</li>
                </ul>

                <p>Verify installation:</p>

                <pre><code>sudo systemctl status k3s
sudo kubectl get nodes</code></pre>

                <h3>Step 2: Retrieve the Node Token</h3>

                <p>Worker nodes need a token to join the cluster securely. Retrieve it with:</p>

                <pre><code>sudo cat /var/lib/rancher/k3s/server/node-token</code></pre>

                <p>Copy this token‚Äîyou'll need it for the worker nodes. It looks something like:</p>

                <pre><code>K107c4e1b2a8f3d9e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c4d3::server:a1b2c3d4e5f6</code></pre>

                <h3>Step 3: Join Worker Nodes</h3>

                <p>SSH into worker1:</p>

                <pre><code>ssh ubuntu@10.10.10.12</code></pre>

                <p>Install K3s agent and join the cluster:</p>

                <pre><code>curl -sfL https://get.k3s.io | K3S_URL="https://10.10.10.11:6443" \
K3S_TOKEN="&lt;YOUR_TOKEN_HERE&gt;" sh -</code></pre>

                <p>Repeat for worker3:</p>

                <pre><code>ssh ubuntu@10.10.10.13
curl -sfL https://get.k3s.io | K3S_URL="https://10.10.10.11:6443" \
K3S_TOKEN="&lt;YOUR_TOKEN_HERE&gt;" sh -</code></pre>

                <p><strong>Important:</strong> Replace <code>&lt;YOUR_TOKEN_HERE&gt;</code> with the actual token from the master node.</p>

                <h3>Step 4: Verify Cluster Health</h3>

                <p>Back on the master node, check that all nodes joined successfully:</p>

                <pre><code>sudo kubectl get nodes</code></pre>

                <p>Expected output:</p>

                <pre><code>NAME      STATUS   ROLES                  AGE   VERSION
cluster   Ready    control-plane,master   5m    v1.28.x+k3s1
worker1   Ready    &lt;none&gt;                 2m    v1.28.x+k3s1
worker3   Ready    &lt;none&gt;                 1m    v1.28.x+k3s1</code></pre>

                <p>All nodes should show <code>Ready</code> status. If a node shows <code>NotReady</code>, check the K3s service logs with <code>sudo journalctl -u k3s -f</code> (master) or <code>sudo journalctl -u k3s-agent -f</code> (workers).</p>

                <div class="info-box" style="text-align: center;">
                    <img src="images/commands.png" alt="SSH Sessions to K3s Nodes" style="max-width: 100%; border-radius: 8px;">
                    <p style="margin-top: 1rem; color: var(--text-secondary); font-style: italic;">
                        <strong>SSH Sessions from PowerShell</strong> - Connecting to K3s master and worker nodes (worker1 and worker3) for cluster management
                    </p>
                </div>

                <div class="info-box" style="text-align: center;">
                    <img src="images/3-node Kubernetes cluster.png" alt="3-Node K3s Cluster Status" style="max-width: 100%; border-radius: 8px;">
                    <p style="margin-top: 1rem; color: var(--text-secondary); font-style: italic;">
                        <strong>Live 3-Node K3s Cluster</strong> - All nodes are Ready and running. You can see the nginx deployment is up and running as a test. More applications will be deployed soon!
                    </p>
                </div>

                <h2>üìÅ Part 4: Configuring kubectl on Your Workstation</h2>

                <p>Managing the cluster from your laptop is more convenient than SSH'ing into the master node every time. Let's set up remote access.</p>

                <h3>Copy Kubeconfig from Master</h3>

                <p>On the master node, the kubeconfig file is located at <code>/etc/rancher/k3s/k3s.yaml</code>. Copy it to your laptop:</p>

                <pre><code># On your laptop
scp ubuntu@10.10.10.11:/etc/rancher/k3s/k3s.yaml ~/.kube/config</code></pre>

                <h3>Update Server Address</h3>

                <p>Edit <code>~/.kube/config</code> and change the server address from <code>127.0.0.1</code> to your master's IP:</p>

                <pre><code>apiVersion: v1
clusters:
- cluster:
    server: https://10.10.10.11:6443  # Change from 127.0.0.1</code></pre>

                <h3>Set Proper Permissions</h3>

                <pre><code>chmod 600 ~/.kube/config</code></pre>

                <h3>Test Remote Access</h3>

                <pre><code>kubectl get nodes</code></pre>

                <p>You should see all three nodes listed. Congratulations! You're now managing your homelab cluster from your workstation.</p>

                <h3>Quick Verification Commands</h3>

                <pre><code># Check cluster info
kubectl cluster-info

# View all pods across namespaces
kubectl get pods --all-namespaces

# Check K3s-specific components
kubectl get pods -n kube-system</code></pre>

                <h2>üéì What You've Built</h2>

                <p>Let's recap what you now have running:</p>

                <ul>
                    <li><strong>High Availability Foundation</strong>: Three-node cluster that can survive single-node failures</li>
                    <li><strong>Infrastructure as Code</strong>: Reproducible VM deployment via Terraform</li>
                    <li><strong>Production-Like Environment</strong>: Real Kubernetes distribution (K3s) that behaves like full K8s</li>
                    <li><strong>Remote Management</strong>: Full kubectl access from your workstation</li>
                    <li><strong>Scalable Platform</strong>: Ready for deploying applications, testing, and learning</li>
                </ul>

                <h2>üöÄ Next Steps</h2>

                <p>Now that your cluster is running, here are some ideas for what to do next:</p>

                <h3>Deploy Your First Application</h3>

                <pre><code>kubectl create deployment nginx --image=nginx
kubectl expose deployment nginx --port=80 --type=NodePort
kubectl get services</code></pre>

                <h3>Install Essential Tools</h3>

                <ul>
                    <li><strong>Helm</strong>: Package manager for Kubernetes</li>
                    <li><strong>MetalLB</strong>: Load balancer for bare metal</li>
                    <li><strong>Cert-Manager</strong>: Automated TLS certificates</li>
                    <li><strong>Longhorn</strong>: Distributed block storage</li>
                    <li><strong>Traefik</strong> or <strong>Nginx Ingress</strong>: Ingress controllers</li>
                </ul>

                <h3>Add Monitoring</h3>

                <ul>
                    <li><strong>Prometheus + Grafana</strong>: Metrics and visualization</li>
                    <li><strong>k9s</strong>: Terminal UI for Kubernetes</li>
                </ul>

                <h3>Explore GitOps</h3>

                <ul>
                    <li><strong>ArgoCD</strong> or <strong>Flux</strong>: Automated deployments from Git</li>
                </ul>

                <h2>üí° Tips and Best Practices</h2>

                <p><strong>Backup Your Kubeconfig</strong>: Store it securely and keep backups. Without it, you'll need to SSH into the master to manage the cluster.</p>

                <p><strong>Use Labels</strong>: Tag nodes with roles or capabilities for targeted pod scheduling.</p>

                <p><strong>Resource Limits</strong>: Always set resource requests and limits for production workloads.</p>

                <p><strong>Regular Updates</strong>: Keep K3s updated with <code>sudo systemctl restart k3s</code> (master) and <code>sudo systemctl restart k3s-agent</code> (workers) after upgrading.</p>

                <p><strong>Snapshot VMs</strong>: Take Proxmox snapshots before major changes. They're lifesavers when experiments go wrong.</p>

                <h2>Cluster Upgrade: Version 2 - Building a 6-Node Kubernetes Cluster with GitLab GitOps</h2>

                <p>After successfully running the 3-node K3s cluster, the next evolution is building a production-ready 6-node cluster managed through GitLab GitOps workflows. This upgrade combines k3s for lightweight orchestration, Proxmox for virtualization, and Longhorn for distributed persistent storage‚Äîall orchestrated through GitLab CI/CD pipelines and ArgoCD for declarative deployments.</p>

                <h3>Complete Guide: Proxmox, k3s, GitLab CI/CD, and Longhorn Storage</h3>

                <h3>Introduction and Architecture Overview</h3>

                <p>This upgrade walks through building a 6-node production-ready Kubernetes cluster managed through GitLab GitOps workflows. The cluster combines k3s for lightweight orchestration, Proxmox for virtualization, and Longhorn for distributed persistent storage‚Äîall orchestrated through GitLab CI/CD pipelines and ArgoCD for declarative deployments. This creates an enterprise-grade learning environment where infrastructure changes flow through Git commits to your running cluster.</p>

                <h3>What You're Building</h3>

                <p>A fully GitOps-managed 6-node cluster with GitLab as the source of truth for all infrastructure and application deployments. Every change‚Äîfrom network policy to application versions‚Äîlives in your GitLab repository and automatically syncs to the cluster.</p>

                <h3>Target Cluster Architecture</h3>

                <p>A 6-node Kubernetes cluster optimized for learning enterprise patterns:</p>

                <table>
                    <thead>
                        <tr>
                            <th>Node Type</th>
                            <th>Count</th>
                            <th>Configuration</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>k3s Server (Control Plane)</td>
                            <td>3</td>
                            <td>2 vCPU, 4GB RAM each</td>
                        </tr>
                        <tr>
                            <td>k3s Agent (Worker)</td>
                            <td>3</td>
                            <td>2 vCPU, 3GB RAM each</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Key Technology Stack</h3>

                <ul>
                    <li><strong>k3s</strong>: Lightweight Kubernetes</li>
                    <li><strong>Proxmox</strong>: Virtualization Layer</li>
                    <li><strong>GitLab</strong>: Source Control and CI/CD</li>
                    <li><strong>ArgoCD</strong>: Declarative Deployment</li>
                    <li><strong>Longhorn</strong>: Distributed Storage</li>
                    <li><strong>External Secrets Operator</strong>: Vault Integration</li>
                </ul>

                <h3>GitOps Workflow</h3>

                <p>Your cluster is managed entirely through Git. The flow works like this:</p>

                <ol>
                    <li>Developer commits Kubernetes manifests to GitLab</li>
                    <li>GitLab CI/CD pipeline runs validation and tests</li>
                    <li>Pipeline updates image versions in GitOps repository</li>
                    <li>ArgoCD detects the Git change</li>
                    <li>Cluster automatically synchronizes to match Git state</li>
                </ol>

                <h2>Your 6-Node Cluster Configuration</h2>

                <h3>Cluster Node IPs</h3>

                <p>Your 6-node cluster uses static IP addressing. Update these values in all commands to match your actual setup:</p>

                <table>
                    <thead>
                        <tr>
                            <th>Node Name</th>
                            <th>Type</th>
                            <th>IP Address</th>
                            <th>Hostname</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Control Plane 1</td>
                            <td>Server</td>
                            <td>10.10.10.21</td>
                            <td>k3s-server-1</td>
                        </tr>
                        <tr>
                            <td>Control Plane 2</td>
                            <td>Server</td>
                            <td>10.10.10.22</td>
                            <td>k3s-server-2</td>
                        </tr>
                        <tr>
                            <td>Control Plane 3</td>
                            <td>Server</td>
                            <td>10.10.10.23</td>
                            <td>k3s-server-3</td>
                        </tr>
                        <tr>
                            <td>Worker 1</td>
                            <td>Agent</td>
                            <td>10.10.10.24</td>
                            <td>k3s-agent-1</td>
                        </tr>
                        <tr>
                            <td>Worker 2</td>
                            <td>Agent</td>
                            <td>10.10.10.25</td>
                            <td>k3s-agent-2</td>
                        </tr>
                        <tr>
                            <td>Worker 3</td>
                            <td>Agent</td>
                            <td>10.10.10.26</td>
                            <td>k3s-agent-3</td>
                        </tr>
                    </tbody>
                </table>

                <h3>k3s Installation Quick Reference</h3>

                <p>Replace the IP addresses in these commands with your actual cluster IPs:</p>

                <pre><code># On first server (k3s-server-1)
curl -sfL https://get.k3s.io | sh -

# Get the token for additional nodes
sudo cat /var/lib/rancher/k3s/server/node-token

# On additional servers (k3s-server-2, k3s-server-3)
curl -sfL https://get.k3s.io | K3S_TOKEN="&lt;token&gt;" \
K3S_URL="https://10.10.10.21:6443" sh -

# On agents (k3s-agent-1, k3s-agent-2, k3s-agent-3)
curl -sfL https://get.k3s.io | K3S_TOKEN="&lt;token&gt;" \
K3S_URL="https://10.10.10.21:6443" sh -</code></pre>

                <p>Replace <code>10.10.10.21</code> with the actual IP of your first control plane node, and <code>&lt;token&gt;</code> with the token from <code>sudo cat /var/lib/rancher/k3s/server/node-token</code></p>

                <h2>GitLab Integration and CI/CD Setup</h2>

                <h3>Setting Up GitLab Repository</h3>

                <p>Create a GitLab repository to store all your cluster configurations:</p>

                <ol>
                    <li>Navigate to gitlab.com or your self-hosted GitLab</li>
                    <li>Create new project: <code>kubernetes-homelab</code></li>
                    <li>Initialize with README</li>
                    <li>Clone to your local machine</li>
                </ol>

                <h3>Repository Structure</h3>

                <p>Organize your GitOps repository with this structure:</p>

                <pre><code>kubernetes-homelab/
‚îú‚îÄ‚îÄ .gitlab-ci.yml              # CI/CD pipeline
‚îú‚îÄ‚îÄ cluster/                    # Cluster configuration
‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/         # Storage, networking
‚îÇ   ‚îú‚îÄ‚îÄ argocd/                 # ArgoCD config
‚îÇ   ‚îî‚îÄ‚îÄ namespaces/             # App namespaces
‚îú‚îÄ‚îÄ apps/                       # Application code
‚îÇ   ‚îú‚îÄ‚îÄ app1/
‚îÇ   ‚îî‚îÄ‚îÄ app2/
‚îî‚îÄ‚îÄ docs/                       # Documentation</code></pre>

                <h3>GitLab CI/CD Pipeline Example</h3>

                <p>Create <code>.gitlab-ci.yml</code> to automate your cluster deployments:</p>

                <pre><code>stages:
  - validate
  - test
  - deploy

validate-manifests:
  stage: validate
  image: alpine/helm:latest
  script:
    - helm lint cluster/
    - kubectl apply --dry-run=client -f cluster/

test-manifests:
  stage: test
  image: alpine/k8s:latest
  script:
    - kubectl apply --dry-run=server -f cluster/
    - echo "Manifests validated successfully"

deploy-cluster:
  stage: deploy
  image: alpine/k8s:latest
  only:
    - main
  script:
    - kubectl apply -f cluster/
    - echo "Deployment complete"</code></pre>

                <p>This pipeline automatically validates your Kubernetes manifests whenever you push to GitLab, preventing invalid configurations from being deployed.</p>

                <h2>Longhorn Distributed Storage Setup</h2>

                <h3>Why Longhorn for Your 6-Node Cluster</h3>

                <p>Longhorn provides distributed persistent storage across your 6 nodes, automatically replicating data for high availability. Unlike traditional NFS, Longhorn is cluster-aware and integrates deeply with Kubernetes.</p>

                <h3>Installing Longhorn</h3>

                <p>From your local machine with kubectl access:</p>

                <pre><code># Add Longhorn Helm repository
helm repo add longhorn https://charts.longhorn.io
helm repo update

# Install Longhorn with 3-replica default
helm install longhorn longhorn/longhorn \
  --namespace longhorn-system \
  --create-namespace</code></pre>

                <p>Wait 1-2 minutes for Longhorn pods to be ready:</p>

                <pre><code>kubectl get pods -n longhorn-system</code></pre>

                <h3>Accessing Longhorn UI</h3>

                <p>Port-forward to access the Longhorn dashboard:</p>

                <pre><code>kubectl port-forward -n longhorn-system svc/longhorn-frontend 8080:80</code></pre>

                <p>Then open <code>http://localhost:8080</code> to view your storage dashboard</p>

                <h3>Using Longhorn in Your Applications</h3>

                <p>Create a PersistentVolumeClaim that uses Longhorn:</p>

                <pre><code>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-storage
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn
  resources:
    requests:
      storage: 10Gi</code></pre>

                <p>Your applications can now request persistent storage that automatically replicates across 3 nodes for high availability.</p>

                <h2>ArgoCD GitOps Deployment</h2>

                <h3>Installing ArgoCD</h3>

                <p>ArgoCD watches your GitLab repository and automatically deploys changes:</p>

                <pre><code># Create namespace
kubectl create namespace argocd

# Install ArgoCD
kubectl apply -n argocd -f \
  https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml</code></pre>

                <h3>Accessing ArgoCD UI</h3>

                <p>Get the initial admin password:</p>

                <pre><code>kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d</code></pre>

                <p>Port-forward to ArgoCD:</p>

                <pre><code>kubectl port-forward svc/argocd-server 8080:443 -n argocd</code></pre>

                <p>Then access <code>https://localhost:8080</code> and login with username <code>admin</code> and the password from above.</p>

                <h3>Connect GitLab Repository</h3>

                <p>Configure ArgoCD to sync your GitLab repository through the Web UI:</p>

                <ol>
                    <li>Navigate to Settings ‚Üí Repositories</li>
                    <li>Click "Connect Repo"</li>
                    <li>Enter your GitLab repository URL</li>
                    <li>Add authentication credentials (SSH key or token)</li>
                    <li>Test the connection</li>
                </ol>

                <h3>Create ArgoCD Application</h3>

                <pre><code>apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cluster-config
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://gitlab.com/your-username/kubernetes-homelab.git
    targetRevision: main
    path: cluster
  destination:
    server: https://kubernetes.default.svc
    namespace: default
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>

                <h3>GitOps Workflow in Action</h3>

                <p>Now your complete deployment flow is:</p>

                <ol>
                    <li>Push manifests to GitLab repository</li>
                    <li>GitLab CI/CD validates and runs tests</li>
                    <li>ArgoCD detects the change in GitLab</li>
                    <li>ArgoCD automatically deploys to your 6-node cluster</li>
                </ol>

                <h2>Verifying Your Complete Setup</h2>

                <h3>Check All 6 Nodes</h3>

                <p>Verify all nodes are ready and running k3s:</p>

                <pre><code>kubectl get nodes</code></pre>

                <p>Expected output showing 6 Ready nodes:</p>

                <pre><code>NAME           STATUS   ROLES              AGE   VERSION
k3s-server-1   Ready    control-plane      5m    v1.28.x+k3s1
k3s-server-2   Ready    control-plane      4m    v1.28.x+k3s1
k3s-server-3   Ready    control-plane      3m    v1.28.x+k3s1
k3s-agent-1    Ready    &lt;none&gt;             2m    v1.28.x+k3s1
k3s-agent-2    Ready    &lt;none&gt;             1m    v1.28.x+k3s1
k3s-agent-3    Ready    &lt;none&gt;             30s   v1.28.x+k3s1</code></pre>

                <h3>Check Core Services</h3>

                <p>Verify your stack is fully operational:</p>

                <pre><code># Check Longhorn
kubectl get pods -n longhorn-system

# Check ArgoCD
kubectl get pods -n argocd

# Check storage classes
kubectl get storageclass</code></pre>

                <h3>Test Deployment</h3>

                <p>Deploy a test application via Longhorn storage:</p>

                <pre><code>kubectl run test-app --image=nginx
kubectl get pods -o wide</code></pre>

                <p>Verify it's scheduled on one of your 6 nodes</p>

                <h2>Next Steps: Your Learning Path</h2>

                <p>With your 6-node cluster fully operational and managed through GitOps:</p>

                <ul>
                    <li>Deploy applications through GitLab CI/CD</li>
                    <li>Practice blue-green deployments via ArgoCD</li>
                    <li>Learn Longhorn backup and disaster recovery</li>
                    <li>Implement monitoring with Prometheus and Grafana</li>
                    <li>Set up cross-cluster GitOps (multi-cluster patterns)</li>
                    <li>Master advanced GitOps patterns with Flux or Helm</li>
                </ul>

                <h2>Version 2 Conclusion</h2>

                <p>You've successfully upgraded from a 3-node cluster to a truly production-like 6-node Kubernetes cluster with GitOps workflows. Every change flows through GitLab and GitOps tools, mirroring real enterprise practices. Your cluster now demonstrates the complete modern application delivery lifecycle: write code ‚Üí commit to Git ‚Üí automated testing ‚Üí automatic deployment.</p>

                <p>This setup prepares you for roles in DevOps, SRE, and platform engineering where GitOps and Kubernetes expertise are essential. The upgrade from Version 1 (3-node) to Version 2 (6-node with GitOps) represents a significant step toward mastering production-grade Kubernetes environments.</p>

                <hr>

                <h2>üêõ Troubleshooting Common Issues</h2>

                <p><strong>Node Shows NotReady</strong>: Check network connectivity and ensure K3s service is running.</p>

                <p><strong>Pods Stuck in Pending</strong>: Likely resource constraints. Check with <code>kubectl describe pod &lt;pod-name&gt;</code>.</p>

                <p><strong>Can't Connect from Workstation</strong>: Verify firewall rules allow port 6443 and check kubeconfig server address.</p>

                <p><strong>Worker Won't Join</strong>: Double-check the token and master URL. Token may have expired if master was reinstalled.</p>

                <h2>üéâ Conclusion</h2>

                <p>You now have a fully functional Kubernetes homelab that rivals many production setups. This cluster serves as an excellent learning platform and testing ground for containerized applications.</p>

                <p>The combination of Proxmox for virtualization, Terraform for automation, and K3s for Kubernetes gives you a powerful, reproducible infrastructure that you can tear down and rebuild at will.</p>

                <p>What will you deploy on your cluster first? Let me know in the comments below!</p>

                <div style="background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-primary) 100%); border: 2px solid var(--primary-color); border-radius: 12px; padding: 3rem; margin: 3rem 0; text-align: center;">
                    <h3 style="color: var(--primary-color); margin-bottom: 1.5rem; font-size: 2rem;">üöÄ Deploy Your Own K3s Cluster</h3>
                    
                    <p style="color: var(--text-secondary); margin-bottom: 2rem; font-size: 1.1rem;">
                        Ready to build your own Kubernetes homelab? Get the complete Terraform automation, deployment scripts, and documentation:
                    </p>
                    
                    <div style="margin: 2rem 0;">
                        <a href="https://github.com/ahmed86-star/k3s-homelab" target="_blank" style="display: inline-block; margin: 0.5rem;">
                            <img src="https://img.shields.io/badge/GitHub-k3s--homelab-black?style=for-the-badge&logo=github&logoColor=white" alt="GitHub Repository">
                        </a>
                        <a href="https://github.com/ahmed86-star/k3s-homelab/fork" target="_blank" style="display: inline-block; margin: 0.5rem;">
                            <img src="https://img.shields.io/badge/Fork-Repository-green?style=for-the-badge&logo=github&logoColor=white" alt="Fork Repository">
                        </a>
                    </div>
                    
                    <div style="background: var(--bg-card); border-radius: 8px; padding: 1.5rem; margin: 2rem auto; max-width: 600px; text-align: left;">
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-weight: 600;">Repository includes:</p>
                        <ul style="color: var(--text-secondary); text-align: left; margin: 0; padding-left: 2rem;">
                            <li>Complete Terraform configurations</li>
                            <li>Automated K3s installation scripts</li>
                            <li>Quick start and deployment guides</li>
                            <li>Security best practices</li>
                            <li>Troubleshooting documentation</li>
                            <li>Proxmox integration examples</li>
                        </ul>
                    </div>
                    
                    <p style="color: var(--text-secondary); margin-top: 2rem; font-size: 1rem;">
                        ‚≠ê <strong>Star the repository</strong> | üî± <strong>Fork and customize</strong> | ü§ù <strong>Contribute improvements</strong>
                    </p>
                </div>

                <hr>

                <a href="index.html" class="back-button">‚Üê Back to Blog</a>
            </article>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-links">
                <a href="privacy.html">Privacy Policy</a>
                <a href="cookies.html">Cookie Policy</a>
                <a href="imprint.html">Imprint</a>
            </div>
            <div class="footer-copyright">
                <p>Copyright ¬© Ahmed 2025</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
</body>
</html>

